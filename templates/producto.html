{% extends 'base.html' %}
{% block title %}{{ p.name }} ¬∑ ModaRopa{% endblock %}
{% block content %}

<div class="grid md:grid-cols-2 gap-6">
  <!-- Foto -->
  <div class="border rounded-xl p-4 bg-white shadow relative">
    {% if p.image_path %}
      {% set imagenes = p.image_path.split(',') %}
      <div id="carousel" class="relative">
        <div class="overflow-hidden">
          {% for img in imagenes %}
            <div class="carousel-item {% if loop.index0 != 0 %}hidden{% endif %}">
              <img src="{{ url_for('static', filename='uploads/' ~ img.strip()) }}" alt="{{ p.name }}" class="max-h-96 mx-auto object-contain">
            </div>
          {% endfor %}
        </div>

        <!-- Controles -->
        <button type="button" class="prev absolute left-2 top-1/2 -translate-y-1/2 bg-black text-white rounded-full p-2">‚Äπ</button>
        <button type="button" class="next absolute right-2 top-1/2 -translate-y-1/2 bg-black text-white rounded-full p-2">‚Ä∫</button>
      </div>
    {% else %}
      <span class="text-gray-400">Sin imagen</span>
    {% endif %}
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", () => {
    const items = document.querySelectorAll("#carousel .carousel-item");
    let current = 0;
    function showItem(index) {
      items.forEach((item, i) => item.classList.toggle("hidden", i !== index));
    }
    document.querySelector("#carousel .prev").addEventListener("click", () => {
      current = (current - 1 + items.length) % items.length;
      showItem(current);
    });
    document.querySelector("#carousel .next").addEventListener("click", () => {
      current = (current + 1) % items.length;
      showItem(current);
    });
  });
  </script>

  <!-- Derecha (Descripci√≥n + bot√≥n) -->
  <div class="flex flex-col justify-between border rounded-xl bg-white shadow p-6">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">{{ p.name }}</h1>
      <p class="text-sm text-gray-500 mt-1">Categor√≠a: {{ p.category }}</p>

      <!-- üëï Info adicional -->
      {% if p.sexo %}
        <p class="text-sm text-gray-600 mt-1">Sexo: {{ p.sexo }}</p>
      {% endif %}

      {% if p.talla %}
        <p class="text-sm text-gray-600 mt-1">Tallas: {{ p.talla.replace('-', ' ') }}</p>
      {% endif %}

      {% if p.precio %}
        <p class="text-xl font-bold text-green-600 mt-3">Precio: {{ p.precio }} ‚Ç¨</p>
      {% endif %}

      {% if p.description %}
        <p class="text-gray-700 mt-4">{{ p.description }}</p>
      {% else %}
        <p class="text-gray-400 mt-4">Sin descripci√≥n</p>
      {% endif %}
    </div>

    <div class="mt-6">
      <button onclick="registrarClick({{ p.id }}, '{{ p.url }}')" class="btn-main block w-full text-center px-4 py-3 rounded-lg">
        Comprar en {{ p.afiliado or "tienda" }}
      </button>

      <script>
      function registrarClick(pid, url) {
        fetch(`/click/${pid}`, { method: "POST" })
          .then(() => window.open(url, "_blank"))
          .catch(() => window.open(url, "_blank"));
      }
      </script>
    </div>
  </div>
</div>

<!-- üìå Rese√±as -->
<div class="mt-10 bg-white border rounded-xl shadow p-6">
  <h2 class="text-xl font-semibold text-gray-800 mb-4">Deja tu rese√±a</h2>

  <form method="post" class="space-y-4">
    <input type="text" name="nombre" placeholder="Tu nombre" class="w-full border rounded-lg p-2" required>
    <textarea name="rese√±a" placeholder="Escribe tu rese√±a..." class="w-full border rounded-lg p-2" required></textarea>

    <!-- ‚≠ê Selector de estrellas con medias -->
    <label class="block">
      Valoraci√≥n:
      <div id="star-rating" class="flex items-center gap-1 mt-2 cursor-pointer">
        {% for i in range(1, 6) %}
          <div class="relative inline-block star-wrapper text-3xl text-gray-300">
            <span class="half left-0 absolute inset-y-0 w-1/2 text-center" data-value="{{ (i - 1) + 0.5 }}">‚òÖ</span>
            <span class="half right-0 absolute inset-y-0 w-1/2 text-center" data-value="{{ i }}">‚òÖ</span>
            <span class="base">‚òÖ</span>
          </div>
        {% endfor %}
      </div>
      <input type="hidden" name="valoracion" id="valoracion" required>
    </label>

    <button type="submit" class="btn-main px-4 py-2 rounded-lg">Enviar rese√±a</button>
  </form>
</div>

<!-- üìå Listado de rese√±as -->
<div class="mt-8 bg-white border rounded-xl shadow p-6">
  <h2 class="text-xl font-semibold text-gray-800 mb-4">Rese√±as de clientes</h2>

  {% if rese√±as %}
    <ul class="space-y-4">
      {% for r in rese√±as %}
        <li class="border-b pb-3">
          <p class="font-semibold">{{ r['nombre'] }}</p>

          <!-- Mostrar estrellas con medias -->
          <div class="flex items-center gap-1 text-2xl">
            {% set full = r['valoracion']|int %}
            {% set half = 1 if (r['valoracion'] - full) >= 0.5 else 0 %}
            {% set empty = 5 - full - half %}

            {% for i in range(full) %}
              <span class="text-yellow-400">‚òÖ</span>
            {% endfor %}
            {% if half %}
              <span class="text-yellow-400 half-star">‚òÖ</span>
            {% endif %}
            {% for i in range(empty) %}
              <span class="text-gray-300">‚òÖ</span>
            {% endfor %}
          </div>

          <p class="text-gray-700 mt-1">{{ r['rese√±a'] }}</p>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-gray-500">A√∫n no hay rese√±as para este producto.</p>
  {% endif %}
</div>

<style>
  /* Estrellas en formulario */
  .star-wrapper { width: 2rem; height: 2rem; position: relative; display: inline-block; }
  .star-wrapper .half { position: absolute; cursor: pointer; color: transparent; }
  .star-wrapper .base { color: #d1d5db; }
  .star-wrapper.active .base { color: #facc15; }
  .star-wrapper.half-active .base {
    background: linear-gradient(90deg, #facc15 50%, #d1d5db 50%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  /* Media estrella en listado */
  .half-star {
    background: linear-gradient(90deg, #facc15 50%, #d1d5db 50%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
</style>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const halves = document.querySelectorAll("#star-rating .half");
  const inputValoracion = document.getElementById("valoracion");
  const wrappers = document.querySelectorAll(".star-wrapper");
  let currentValue = 0;

  function updateStars(value) {
    wrappers.forEach((wrapper, i) => {
      wrapper.classList.remove("active", "half-active");
      const starIndex = i + 1;
      if (value >= starIndex) {
        wrapper.classList.add("active");
      } else if (value + 0.5 === starIndex) {
        wrapper.classList.add("half-active");
      }
    });
  }

  halves.forEach(half => {
    half.addEventListener("click", () => {
      currentValue = parseFloat(half.dataset.value);
      inputValoracion.value = currentValue;
      updateStars(currentValue);
    });
    half.addEventListener("mouseenter", () => updateStars(parseFloat(half.dataset.value)));
    half.addEventListener("mouseleave", () => updateStars(currentValue));
  });
});
</script>

{% endblock %}
