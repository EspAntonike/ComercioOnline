<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Listado · Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen text-gray-900">
  <!-- Navbar -->
  <nav class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold text-pink-600">Panel Admin</h1>
    <div>
      <a class="ml-4 text-gray-700 hover:text-pink-600 font-medium" href="/admin/new">Nuevo producto</a>
    </div>
  </nav>

  <!-- Contenido principal -->
  <main class="max-w-7xl mx-auto py-10 px-4">
    <h1 class="text-3xl font-bold mb-6 text-gray-900">Productos</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="space-y-2 mb-6">
          {% for cat, msg in messages %}
            <div class="p-3 rounded-lg border text-sm {{ 'border-green-300 bg-green-50 text-green-800' if cat=='success' else 'border-red-300 bg-red-50 text-red-700' }}">{{ msg }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <div class="overflow-x-auto rounded-2xl border border-gray-200 shadow-sm">
      <table class="min-w-full text-sm table-fixed">
        <thead class="bg-gray-100 text-gray-700 uppercase text-xs font-semibold">
          <tr>
            <th class="p-3 w-12">ID</th>
            <th class="p-3 w-32">Categoría</th>
            <th class="p-3 w-48">Nombre</th>
            <th class="p-3 w-64">URL</th>
            <th class="p-3 w-28">Imagen</th>
            <th class="p-3 w-40">Descripción</th>
            <th class="p-3 w-24">Afiliado</th>
            <th class="p-3 w-32">Tallas</th>
            <th class="p-3 w-20">Sexo</th>
            <th class="p-3 w-24">Precio</th>
            <th class="p-3 w-24">Entradas</th>
            <th class="p-3 w-40">Creado</th>
            <th class="p-3 w-28">Acciones</th>
          </tr>
        </thead>
        <tbody class="bg-white">
          {% for p in products %}
          {% set imgs = p.image_path.split(",") if p.image_path else [] %}
          {% set first_img = imgs[0] if imgs else None %}
          {% set extra_imgs = (imgs|length - 1) if imgs else 0 %}

          <tr class="border-t hover:bg-gray-50">
            <td class="p-3 text-center">{{ p.id }}</td>

            <td class="p-3 max-w-[8rem] truncate whitespace-nowrap overflow-hidden">{{ p.category }}</td>

            <td class="p-3 max-w-[12rem] truncate whitespace-nowrap overflow-hidden">{{ p.name }}</td>

            <!-- URL con ancho fijo, truncado y clicable -->
            <td class="p-3">
              {% if p.url %}
              <a href="{{ p.url }}" target="_blank" rel="noopener noreferrer"
                 class="inline-block align-middle max-w-[16rem] truncate whitespace-nowrap overflow-hidden text-blue-600 hover:underline"
                 title="{{ p.url }}">
                 {{ p.url }}
              </a>
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </td>

            <!-- Imagen (primera) + badge de extra -->
            <td class="p-3">
              {% if first_img %}
                <div class="relative inline-block">
                  <img src="{{ first_img }}" class="h-12 w-12 object-cover rounded-md border" />
                  {% if extra_imgs > 0 %}
                    <span class="absolute -top-1 -right-1 text-[10px] leading-none px-1.5 py-1 rounded-full bg-gray-900 text-white">+{{ extra_imgs }}</span>
                  {% endif %}
                </div>
              {% else %}
                <span class="text-gray-400">—</span>
              {% endif %}
            </td>

            <td class="p-3 max-w-[10rem] truncate whitespace-nowrap overflow-hidden">{{ p.description }}</td>
            <td class="p-3 max-w-[6rem] truncate whitespace-nowrap overflow-hidden">{{ p.afiliado }}</td>
            <td class="p-3 max-w-[8rem] truncate whitespace-nowrap overflow-hidden">{{ p.tallas }}</td>
            <td class="p-3 max-w-[5rem] truncate whitespace-nowrap overflow-hidden">{{ p.sexo }}</td>
            <td class="p-3 max-w-[6rem] truncate whitespace-nowrap overflow-hidden">{{ p.precio }}</td>
            <td class="p-3 text-center">{{ p.entradas }}</td>
            <td class="p-3 max-w-[10rem] truncate whitespace-nowrap overflow-hidden">{{ p.created_at }}</td>

            <td class="p-3">
              <form action="/admin/delete/{{ p.id }}" method="post" onsubmit="return confirm('¿Eliminar este producto?')">
                <button class="px-3 py-1 rounded-lg bg-red-600 text-white text-xs font-medium hover:bg-red-500">
                  Eliminar
                </button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </main>
</body>
</html>
